# Описание проекта Vkinder

*   **Цель проекта** - разработать программу-бота для взаимодействия с базами данных социальной сети. 
Бот предлагает различные варианты людей для знакомств в социальной сети Вконтакте в виде диалога с пользователем.

Выполнена разработка программы-бота на Python, спроектирована и реализована база данных (БД) для программы,
настроено взаимодействие бота с ВК, написана документацию по использованию программы.*

## Структура проекта
- класс VKinder (работа бота, взаимодействие бота с БД)
- класс VkUser (взаимодействие с API VK)
- функционал БД BD_VK (создание таблиц, заполнение и удаление данных)
- файл tests_.py
- файл описания программы README.md
- вспомогательные файлы (requirements.txt, all_tokens.config)

## Работа бота VK (описание внешней работы)

Пользователь заходит в **сообщество VK "VKinder Team-6"**, начинает диалог для отправки сообщений. При первом диалоге
у пользователя появляется кнопка *"Начать"*. После приветствия предлагается нажать кнопку *"поиск"*. После этого
пользователь записывается в таблицу пользователей в базу данных.

Далее бот определяет имя пользователя и указанный в профиле город, обращается к пользователю по имени с вопросом,
производить ли поиск по указанному городу или изменить город поиска. Предложены 2 варианта ответов: *1. Да, 2. Нет*. 
Пользователь в ответном сообщении может напечатать *"да/нет"*, а может просто поставить соответствующую цифру.
После ответа выходят подходящие по мнению программы (логика выбора описана далее в классе VkUser):

Программа определяет самые популярные фото подходящих профилей, бот выдаёт их в количестве трёх штук за одно сообщение
(если у пользователя фото менее трёх, выдаётся соответственно 2 или 1), при этом указывается имя и возраст, 
указанные в профиле. Внизу появляются кнопки *"нравится/не нравится/остановить поиск"*.

При нажатии пользователем кнопки *"нравится"* бот отправляет сообщение-ссылку на профиль (профиль записывается таблицу
фаворитов в базу банных). При нажатии *"не нравится"*, просто выдаётся следующий профиль (профиль, который
не понравился, записывается таблицу ... ).

При нажатии кнопки *"Остановить поиск"* бот спрашивает пользователя, вывести ли список людей, выбранных ранее, и
предложены 2 варианта ответов: *1. Да, 2*. Нет. При ответном сообщении *"да"* или *"1"* выводится список выбранных профилей:
имя, возраст, ссылка на профиль. И предлагается нажать кнопку *"поиск"* для повторного поиска.

**Далее следует подробное описание кода Python: описания классов VKinder и VkUser, функционала работы базы данных.**

### Описание класса VKinder
Класс для представления бота в VK.

#### Атрибуты

conn - соединение с базой данных
user_vk - авторизованный по ключу доступа пользователя
public_vk - авторизованный по ключу сообщества

#### Методы

**write_msg(self, user_id, message, keyboard=None):**
Отправка сообщения пользователю.

**send_photos(self, user_id, likes, owner_id, first_name, age, keyboard):**
Метод, выполняющий отправку фото подходящего человека пользователю. Используется только в связке с другими функциями.

**wait_message(self, longpoll):**
Проверка сообщений, которые пришли боту.

**bot_keyboard(self):**
Создание кнопок в диалоге с пользователем. Метод отвечает за появление кнопок на всех этапах диалога.

**photos(self, event, db_client_id, user, suitable, counter, user_city):**
Метод по отправке данных подходящего человека. Используется в связке с функцией listen.
В функции используется несколько рекурсий, без них бот перестаёт обрабатывать сообщения, каждая рекурсия функции,
новый человек.

**search_peoples(self, event, longpoll, offset, user_city):**
Метод для поиска подходящих людей, выведен в отдельный метод для того чтобы была возможность использовать в рекурсии,
и при остановке поиска или просмотра всех загруженных подходящих не требовалось начинать с самого начала логики бота
user_city - параметр которая указывается при рекурсии,
suitable - список словарей, в котором находятся подходящие, далее делаем по нему цикл

**listen(self, city):**
Начало логики бота.
Тут создаем LongPoll соединение и получаем ответы в реальном времени.
Первое условие реализовано больше для пользователей которые зашли впервые, у них будет кнопка Start & Начать,
Второе условие отвечает за поиск людей.


### Описание класса VkUser 
Класс для представления пользователя в VK. Обеспечивает полное взаимодействие с API VK.
В методах используются запросы как без, так и с библиотекой vk_api.

#### Атрибуты

user_id - id пользователя
conn - соединение с базой данных
user_vk - авторизованный по ключу доступа пользователя
public_vk - авторизованный по ключу сообщества
url - общая часть url для всех методов
params - общая часть параметров для всех методов

#### Методы

**get_user_info(self, user_i):**
Метод на вход при вызове требует параметр id и возвращает информацию с основными данными для записи в базу данных:
id, имя и фамилию, город, пол, возраст и указанный вид отношений. Учтены варианты, если какое-либо из полей
не указаны пользователем. Используется для получении информации как пользователя, так и подходящего профиля.

**search_users_by_city_sex(self, user_city, user_sex, offset):**
  Поиск профилей, по параметрам подходящих пользователю. Метод принимает город пользователя и его пол в качестве
параметров (эти параметры получает из функции get_inf_from_user_id) и возвращает данные профилей VK, которые подходят
пользователю: id VK, имя и фамилия, пол, город проживания и возраст.
  Дополнительно в запросе учитываются следующие параметры: необходимое количество результатов вывода (count),
сортировка по популярности (sort), диапазон возраста (age_from, age_to) наличие фотографий (has_photo),
статус (status) "не женат (не замужем)" или "в активном поиске", а также дата рождения (bdate).
  Значение возраста определяется путём проверки последних 4-х элементов строки даты рождения: если
строка состоит только из цифр, при этом начинается либо с 19.., либо с 20.. - возраст получаем путём разности
2022(текущего года) и последних 4-х элементов строки даты рождения, перевелённых в тип данных int.
Иначе в значении указываем, что возраст не задан.

**dump_json(self):**
Запись в файл. Метод записи в файл выполняет запись результирующего в указанный файл формата json и
возвращает подтверждение записи. В итоговой версии программы не используется, оставлена для выполнения
проверок и локальных задач, которые могут возникнуть при расширении функционала программы. Удобен в случае
пребразования результата метода search_users_by_city_sex в список для проверки результата.

**get_likes_most_popular_photos(self, owner_id):**
Мотод получает самые популярные фотографии пользователя по номеру id, который получен результатом метода
поиска подходящих вариантов.

**enumeration_ids(self, counter, suitable):**
Метод выполняет получение данных по подходящим пользователю профилям. Если у подходящего нет нужных фото,
то ищем по следующему, пока не найдем. На вход принимает счётчик для рекурсии, и список словарей с подходящими.
Выводит данные по подходящему профилю.

**check_is_сlosed(self, user_id):**
Проверка на закрытый доступ к аккаунту. Метод отдельно написан для тестирования и является
частью search_users_by_city_sex. 

**check_in_favorites_blocked(self, user_id):**
Проверка на нахождение профиля в списке, непонравившихся ранее. Метод отдельно написан для тестирования и является
частью search_users_by_city_sex. 


### Описание функционала работы базы данных

В модуле BD_VK реализовано взаимодействие с базой данных на сервере.
Все функции, требующие входных данных, получают их при вызове в модулях VKinder и VKUser.

  **Функция create_table** создаёт три таблицы в базе данных: client, favorites, blocked. Тип связи: один ко многим.
Первичные ключи во всех таблицах - id. Вторичные ключи в таблицах blocked и favorites - id_client. 

  **Функция drop_table_all** удаляут все таблицы из базы данных при каждом новом запуске. Функция insert_client принимает
на вход такие данные: (Имя: str, Фамилия: str, Город: str, Возраст: int, ID VK: int, Пол: str. 
Данные берутся из профиля пользователя из модуля VKinder. Ничего не возвращает, результатом ее работы
является заполнение таблицы "сlient".
  **Функция insert_favorites** принимает на вход такие данные: (id_Клиента(порядковый номер): int, Имя: str, Фамилия: str, 
Город: str, Возраст: int, ID VK: int, Пол: str). Данные берутся из профиля пользователя, которому поставлен лайк.
В модуле VKinder. Так же ничего не возвращает, результатом ее работы является заполнение таблицы "favorites".
  **Функция insert_blocked** принимает на вход такие данные: (id_Клиента(порядковый номер): int, ID VK: int) 
Данные берутся из профиля пользователя, которому поставлен дизлайк из модуля VKinder. Так же ничего не возвращает,
результатом ее работы является заполнение таблицы "blocked".
  **Функция search_count_first** не принимает на вход никаких данных. Возвращает идентификатор(порядковый номер) клиента,
записанного в таблицу впервые. Используется в функциях insert_favorites, insert_blocked.
  **Функция search_count** принимает на вход ID VK пользователя(check: int). Возвращает идентификатор(порядковый номер)
клиента, ранее записанного в таблицу. Функция выводит идентификатор(порядковый номер клиента) по его ID VK.
Используется в функциях insert_favorites, insert_blocked.

  Удаление данных предусмотрено по выбору, то есть по id vk человека в избранном или чс. Можно конкретного любого
удалить. Или при изменении города, автоматом удаляются люди в избранном, у которых старый город.
  **Функция delete_blocked** принимает на вход ID VK пользователя(check: int), находящегося в черном списке.
Производит удаление записи с этим пользователем из таблицы "blocked" в соответствие с его ID VK. Ничего не возвращает.
  **Функция delete_favorites** принимает на вход ID VK пользователя(check: int), находящегося в списке избранных. 
Производит удаление записи с этим пользователем из таблицы "Favorites" в соответствие с его ID VK. Ничего не возвращает.
  
  **Функция result_favorites** принимает на вход ID VK пользователя (check: int)(Клиента). Возвращает список пользователей,
находящихся в избранном, в соответствие с его ID VK (Клиента). Данные вывода: (Имя: str, Фамилия: str, Город: str,
Возраст: int, ID VK: int, Пол: str)
 **Функция result_blocked** принимает на вход ID VK пользователя(check: int)(Клиента). Возвращает список ID VK пользователей,
находящихся в черном списке, в соответствие с его ID VK (Клиента). Данные вывода: (ID VK: int).
  **Функция result_favorites_id** принимает на вход ID VK пользователя(check: int)(Клиента). Возвращает список ID VK
пользователей, находящихся в избранном, в соответствие с его ID VK (Клиента). Данные вывода: (ID VK: int).
  **Функция result_favorites_blocked** принимает на вход ID VK пользователя(check: int)(Клиента). 
Возвращает список ID VK пользователей, находящихся в избранном и ID VK пользователей, находящихся в черном списке,
в соответствие с ID VK Клиента. Данные вывода: (ID VK: int(избранных), ID VK: int(чс)).
  **Функция check_client** принимет на вход ID VK пользователя(Клиента)(check: int). Производится поиск соответствия
введенному ID VK пользователя(Клиента) с ранее записанными в таблицу. Возвращает ID VK пользователя(Клиента)
если найдено, и пустой кортеж если не найдено.
  **Функция result_favorites_first** не принимает на вход ничего. Выводит всех пользователей, находящихся в избранном
для клиента, который воспользовался ПО впервые. Нет необходимости искать его ID VK по всей таблице.
Работает в связке с check_client.
  **Функция result_blocked_first** не принимает на вход ничего. Выводит всех пользователей, находящихся в чс для клиента,
который воспользовался ПО впервые. Нет необходимости искать его ID VK по всей таблице. Работает в связке с
check_client.
  **Функция update_city_delete_favorites** принимает на вход ((ID VK пользователя(Клиента))check: int, (Новое название
города)city_new: str). Производится изменение названия города для Пользователя(Клиента) с ID VK = check и удаление
для этого клиента всех пользователей в избранном(таблица Favorites). Ничего не возвращает.
  **Функция result_blocked_all** не принимает на вход ничего. Возвращает список всех ID VK(пользователей в чс)) для всех
клиентов.
